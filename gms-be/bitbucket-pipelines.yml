pipelines:
  branches:
    main:
      - step:
          name: Deploy on API Server
          runs-on:
            - self.hosted
            - linux.shell
          working_directory: /home/ubuntu/gms-be
          script:
            - echo "ğŸš€ Starting deployment..."

            - echo "ğŸ”‘ Setting permissions..."
            - sudo chown -R ubuntu:ubuntu /home/ubuntu/gms-be
            - cd /home/ubuntu/gms-be
            - cp .env ../
            - echo "ğŸ›‘ Stopping old PM2 process..."
            - sudo pm2 stop gms-be || true
            - sudo pm2 delete gms-be || true

            - echo "ğŸ”„ Updating code..."
            - git clean -fdx
            - git fetch --all
            - git reset --hard origin/main

            - echo "ğŸ§¹ Cleaning dependencies & Prisma..."
            - npm cache clean --force
            - cp /home/ubuntu/.env /home/ubuntu/gms-be

            - echo "ğŸ“¦ Installing dependencies..."
            - npm install
  
            - echo "ğŸ—ï¸ Building project..."
            - npm run build
            - npx prisma generate
            - sleep 20
            - echo "ğŸš€ Starting PM2..."
            - sudo pm2 start dist/src/main.js --name gms-be

            - echo "âœ… Deployment completed!"
